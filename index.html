import React, { useState, useEffect } from 'react';
import { Calendar, Heart, TrendingUp, Settings, Plus, ChevronLeft, ChevronRight } from 'lucide-react';

const MenstrualMoodTracker = () => {
  const [activeTab, setActiveTab] = useState('track');
  const [data, setData] = useState({
    lastPeriodStart: null,
    cycleLength: 28,
    periodLength: 5,
    entries: {} // date -> { moods: [], symptoms: [], notes: '' }
  });

  const moods = [
    { id: 'happy', name: 'Happy', emoji: 'ðŸ˜Š', color: 'bg-yellow-100 text-yellow-800' },
    { id: 'sad', name: 'Sad', emoji: 'ðŸ˜¢', color: 'bg-blue-100 text-blue-800' },
    { id: 'angry', name: 'Angry', emoji: 'ðŸ˜¤', color: 'bg-red-100 text-red-800' },
    { id: 'anxious', name: 'Anxious', emoji: 'ðŸ˜°', color: 'bg-purple-100 text-purple-800' },
    { id: 'energetic', name: 'Energetic', emoji: 'âš¡', color: 'bg-orange-100 text-orange-800' },
    { id: 'tired', name: 'Tired', emoji: 'ðŸ˜´', color: 'bg-gray-100 text-gray-800' },
    { id: 'emotional', name: 'Emotional', emoji: 'ðŸ¥º', color: 'bg-pink-100 text-pink-800' },
    { id: 'calm', name: 'Calm', emoji: 'ðŸ˜Œ', color: 'bg-green-100 text-green-800' }
  ];

  const symptoms = [
    'Cramps', 'Bloating', 'Headache', 'Breast tenderness', 
    'Acne', 'Cravings', 'Nausea', 'Fatigue', 'Mood swings'
  ];

  const formatDate = (date) => date.toISOString().split('T')[0];

  const getCycleDay = (date) => {
    if (!data.lastPeriodStart) return null;
    const start = new Date(data.lastPeriodStart);
    const diff = Math.floor((date - start) / (1000 * 60 * 60 * 24)) + 1;
    return diff > 0 ? diff : null;
  };

  const getCyclePhase = (cycleDay) => {
    if (!cycleDay) return { name: 'Unknown', color: 'bg-gray-200' };
    
    if (cycleDay <= data.periodLength) {
      return { name: 'Menstrual', color: 'bg-red-200' };
    } else if (cycleDay <= 13) {
      return { name: 'Follicular', color: 'bg-green-200' };
    } else if (cycleDay <= 15) {
      return { name: 'Ovulation', color: 'bg-yellow-200' };
    } else {
      return { name: 'Luteal', color: 'bg-purple-200' };
    }
  };

  const updateEntry = (date, field, value) => {
    const dateStr = formatDate(date);
    setData(prev => ({
      ...prev,
      entries: {
        ...prev.entries,
        [dateStr]: {
          moods: [],
          symptoms: [],
          notes: '',
          ...prev.entries[dateStr],
          [field]: value
        }
      }
    }));
  };

  const toggleMood = (date, moodId) => {
    const dateStr = formatDate(date);
    const currentMoods = data.entries[dateStr]?.moods || [];
    const newMoods = currentMoods.includes(moodId) 
      ? currentMoods.filter(m => m !== moodId)
      : [...currentMoods, moodId];
    
    updateEntry(date, 'moods', newMoods);
  };

  const toggleSymptom = (date, symptom) => {
    const dateStr = formatDate(date);
    const currentSymptoms = data.entries[dateStr]?.symptoms || [];
    const newSymptoms = currentSymptoms.includes(symptom)
      ? currentSymptoms.filter(s => s !== symptom)
      : [...currentSymptoms, symptom];
    
    updateEntry(date, 'symptoms', newSymptoms);
  };

  // Track Tab Component
  const TrackTab = () => {
    const today = new Date();
    const cycleDay = getCycleDay(today);
    const phase = getCyclePhase(cycleDay);
    const todayEntry = data.entries[formatDate(today)] || { moods: [], symptoms: [], notes: '' };

    return (
      <div className="p-4 space-y-6">
        {/* Cycle Status */}
        <div className="bg-white rounded-xl p-6 shadow-sm">
          <div className="text-center">
            <div className={`inline-block px-4 py-2 rounded-full ${phase.color} font-medium mb-2`}>
              {phase.name} Phase
            </div>
            <p className="text-gray-600">
              {cycleDay ? `Day ${cycleDay} of cycle` : 'Set your period start date'}
            </p>
          </div>
        </div>

        {/* Mood Selection */}
        <div className="bg-white rounded-xl p-6 shadow-sm">
          <h2 className="text-lg font-semibold mb-4">How are you feeling?</h2>
          <div className="grid grid-cols-2 gap-3">
            {moods.map(mood => (
              <button
                key={mood.id}
                onClick={() => toggleMood(today, mood.id)}
                className={`p-3 rounded-lg border-2 transition-all ${
                  todayEntry.moods.includes(mood.id)
                    ? `${mood.color} border-current`
                    : 'border-gray-200 hover:border-gray-300'
                }`}
              >
                <div className="text-2xl mb-1">{mood.emoji}</div>
                <div className="text-sm font-medium">{mood.name}</div>
              </button>
            ))}
          </div>
        </div>

        {/* Symptoms */}
        <div className="bg-white rounded-xl p-6 shadow-sm">
          <h2 className="text-lg font-semibold mb-4">Symptoms</h2>
          <div className="flex flex-wrap gap-2">
            {symptoms.map(symptom => (
              <button
                key={symptom}
                onClick={() => toggleSymptom(today, symptom)}
                className={`px-3 py-2 rounded-full text-sm font-medium transition-all ${
                  todayEntry.symptoms.includes(symptom)
                    ? 'bg-rose-500 text-white'
                    : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                }`}
              >
                {symptom}
              </button>
            ))}
          </div>
        </div>

        {/* Notes */}
        <div className="bg-white rounded-xl p-6 shadow-sm">
          <h2 className="text-lg font-semibold mb-4">Notes</h2>
          <textarea
            value={todayEntry.notes}
            onChange={(e) => updateEntry(today, 'notes', e.target.value)}
            placeholder="How are you feeling today? Any observations?"
            className="w-full p-3 border border-gray-200 rounded-lg resize-none"
            rows="3"
          />
        </div>
      </div>
    );
  };

  // Calendar Tab Component
  const CalendarTab = () => {
    const [currentMonth, setCurrentMonth] = useState(new Date());
    
    const getDaysInMonth = () => {
      const year = currentMonth.getFullYear();
      const month = currentMonth.getMonth();
      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const startDate = new Date(firstDay);
      startDate.setDate(startDate.getDate() - firstDay.getDay());
      
      const days = [];
      for (let i = 0; i < 42; i++) {
        const date = new Date(startDate);
        date.setDate(startDate.getDate() + i);
        days.push(date);
      }
      return days;
    };

    const days = getDaysInMonth();
    const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun',
      'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

    return (
      <div className="p-4">
        <div className="bg-white rounded-xl p-4 shadow-sm">
          {/* Calendar Header */}
          <div className="flex items-center justify-between mb-4">
            <button
              onClick={() => setCurrentMonth(new Date(currentMonth.getFullYear(), currentMonth.getMonth() - 1))}
              className="p-2 hover:bg-gray-100 rounded-lg"
            >
              <ChevronLeft className="w-5 h-5" />
            </button>
            <h2 className="text-lg font-semibold">
              {monthNames[currentMonth.getMonth()]} {currentMonth.getFullYear()}
            </h2>
            <button
              onClick={() => setCurrentMonth(new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1))}
              className="p-2 hover:bg-gray-100 rounded-lg"
            >
              <ChevronRight className="w-5 h-5" />
            </button>
          </div>

          {/* Day Headers */}
          <div className="grid grid-cols-7 gap-1 mb-2">
            {['S', 'M', 'T', 'W', 'T', 'F', 'S'].map(day => (
              <div key={day} className="text-center text-xs font-medium text-gray-500 p-2">
                {day}
              </div>
            ))}
          </div>

          {/* Calendar Grid */}
          <div className="grid grid-cols-7 gap-1">
            {days.map((day, index) => {
              const dateStr = formatDate(day);
              const entry = data.entries[dateStr];
              const cycleDay = getCycleDay(day);
              const phase = getCyclePhase(cycleDay);
              const isCurrentMonth = day.getMonth() === currentMonth.getMonth();
              const isToday = formatDate(day) === formatDate(new Date());
              
              return (
                <div
                  key={index}
                  className={`relative p-2 h-12 rounded ${
                    isCurrentMonth ? 'bg-white' : 'bg-gray-50'
                  } ${isToday ? 'ring-2 ring-rose-400' : ''}`}
                >
                  <div className={`text-sm ${isCurrentMonth ? 'text-gray-900' : 'text-gray-400'}`}>
                    {day.getDate()}
                  </div>
                  
                  {/* Cycle phase indicator */}
                  {cycleDay && isCurrentMonth && (
                    <div className={`absolute top-1 right-1 w-2 h-2 rounded-full ${
                      phase.name === 'Menstrual' ? 'bg-red-400' :
                      phase.name === 'Follicular' ? 'bg-green-400' :
                      phase.name === 'Ovulation' ? 'bg-yellow-400' : 'bg-purple-400'
                    }`} />
                  )}
                  
                  {/* Mood indicators */}
                  {entry && entry.moods.length > 0 && (
                    <div className="absolute bottom-1 left-1 flex">
                      <div className="w-1 h-1 rounded-full bg-rose-400" />
                    </div>
                  )}
                </div>
              );
            })}
          </div>
        </div>
      </div>
    );
  };

  // Insights Tab Component
  const InsightsTab = () => {
    const getMoodsByPhase = () => {
      const phaseData = {
        'Menstrual': {},
        'Follicular': {},
        'Ovulation': {},
        'Luteal': {}
      };

      Object.entries(data.entries).forEach(([dateStr, entry]) => {
        const date = new Date(dateStr);
        const cycleDay = getCycleDay(date);
        const phase = getCyclePhase(cycleDay);
        
        if (phase.name !== 'Unknown' && entry.moods) {
          if (!phaseData[phase.name]) phaseData[phase.name] = {};
          entry.moods.forEach(moodId => {
            phaseData[phase.name][moodId] = (phaseData[phase.name][moodId] || 0) + 1;
          });
        }
      });

      return phaseData;
    };

    const phaseData = getMoodsByPhase();

    return (
      <div className="p-4 space-y-6">
        <div className="bg-white rounded-xl p-6 shadow-sm">
          <h2 className="text-lg font-semibold mb-4">Mood Patterns by Phase</h2>
          
          {Object.entries(phaseData).map(([phase, moodCounts]) => (
            <div key={phase} className="mb-6">
              <h3 className="font-medium text-gray-800 mb-3">{phase}</h3>
              
              {Object.keys(moodCounts).length > 0 ? (
                <div className="space-y-2">
                  {Object.entries(moodCounts).map(([moodId, count]) => {
                    const mood = moods.find(m => m.id === moodId);
                    return (
                      <div key={moodId} className="flex items-center space-x-3">
                        <span className="text-lg">{mood?.emoji}</span>
                        <span className="text-sm font-medium flex-1">{mood?.name}</span>
                        <span className="text-sm text-gray-600">{count} times</span>
                      </div>
                    );
                  })}
                </div>
              ) : (
                <p className="text-gray-500 text-sm">No mood data yet</p>
              )}
            </div>
          ))}
        </div>

        {/* Sample Data Button */}
        <div className="bg-white rounded-xl p-6 shadow-sm">
          <h3 className="font-medium text-gray-800 mb-3">Demo Data</h3>
          <button
            onClick={() => {
              const today = new Date();
              const sampleData = {
                lastPeriodStart: new Date(today.getFullYear(), today.getMonth(), today.getDate() - 10).toISOString(),
                cycleLength: 28,
                periodLength: 5,
                entries: {
                  [formatDate(new Date(today.getFullYear(), today.getMonth(), today.getDate() - 10))]: {
                    moods: ['sad', 'tired'], symptoms: ['Cramps', 'Bloating'], notes: 'First day of period'
                  },
                  [formatDate(new Date(today.getFullYear(), today.getMonth(), today.getDate() - 5))]: {
                    moods: ['energetic', 'happy'], symptoms: [], notes: 'Feeling better'
                  },
                  [formatDate(today)]: {
                    moods: ['calm', 'happy'], symptoms: [], notes: 'Good day today'
                  }
                }
              };
              setData(sampleData);
            }}
            className="w-full bg-blue-500 text-white py-2 rounded-lg font-medium hover:bg-blue-600 transition-colors"
          >
            Load Sample Data
          </button>
        </div>
      </div>
    );
  };

  // Settings Tab Component
  const SettingsTab = () => {
    const [periodDate, setPeriodDate] = useState(
      data.lastPeriodStart ? new Date(data.lastPeriodStart).toISOString().split('T')[0] : ''
    );

    const handleSave = () => {
      setData(prev => ({
        ...prev,
        lastPeriodStart: periodDate ? new Date(periodDate).toISOString() : null
      }));
    };

    return (
      <div className="p-4 space-y-6">
        <div className="bg-white rounded-xl p-6 shadow-sm">
          <h2 className="text-lg font-semibold mb-4">Cycle Settings</h2>
          
          <div className="space-y-4">
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">
                Last Period Start Date
              </label>
              <input
                type="date"
                value={periodDate}
                onChange={(e) => setPeriodDate(e.target.value)}
                className="w-full p-3 border border-gray-200 rounded-lg"
              />
            </div>
            
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">
                Cycle Length (days)
              </label>
              <input
                type="number"
                value={data.cycleLength}
                onChange={(e) => setData(prev => ({ ...prev, cycleLength: parseInt(e.target.value) || 28 }))}
                className="w-full p-3 border border-gray-200 rounded-lg"
                min="21"
                max="45"
              />
            </div>
            
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">
                Period Length (days)
              </label>
              <input
                type="number"
                value={data.periodLength}
                onChange={(e) => setData(prev => ({ ...prev, periodLength: parseInt(e.target.value) || 5 }))}
                className="w-full p-3 border border-gray-200 rounded-lg"
                min="3"
                max="10"
              />
            </div>
            
            <button
              onClick={handleSave}
              className="w-full bg-rose-500 text-white py-3 rounded-lg font-medium hover:bg-rose-600 transition-colors"
            >
              Save Settings
            </button>
          </div>
        </div>
      </div>
    );
  };

  const tabs = [
    { id: 'track', name: 'Track', icon: Plus, component: TrackTab },
    { id: 'calendar', name: 'Calendar', icon: Calendar, component: CalendarTab },
    { id: 'insights', name: 'Insights', icon: TrendingUp, component: InsightsTab },
    { id: 'settings', name: 'Settings', icon: Settings, component: SettingsTab }
  ];

  const ActiveComponent = tabs.find(tab => tab.id === activeTab)?.component || TrackTab;

  return (
    <div className="max-w-sm mx-auto min-h-screen bg-gray-50">
      {/* Header */}
      <div className="bg-gradient-to-r from-rose-400 to-pink-500 text-white p-6">
        <div className="flex items-center space-x-3">
          <Heart className="w-8 h-8" />
          <div>
            <h1 className="text-xl font-bold">Cycle Mood Tracker</h1>
            <p className="text-rose-100 text-sm">Track your journey</p>
          </div>
        </div>
      </div>

      {/* Main Content */}
      <div className="pb-20">
        <ActiveComponent />
      </div>

      {/* Bottom Navigation */}
      <div className="fixed bottom-0 left-1/2 transform -translate-x-1/2 w-full max-w-sm bg-white border-t border-gray-200">
        <div className="flex">
          {tabs.map(tab => {
            const Icon = tab.icon;
            return (
              <button
                key={tab.id}
                onClick={() => setActiveTab(tab.id)}
                className={`flex-1 p-4 flex flex-col items-center space-y-1 transition-colors ${
                  activeTab === tab.id 
                    ? 'text-rose-500 bg-rose-50' 
                    : 'text-gray-500 hover:text-gray-700'
                }`}
              >
                <Icon className="w-5 h-5" />
                <span className="text-xs font-medium">{tab.name}</span>
              </button>
            );
          })}
        </div>
      </div>
    </div>
  );
};

export default MenstrualMoodTracker;
